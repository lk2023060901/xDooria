# 游戏服务列表

## 概述

xDooria 游戏服务端采用微服务架构，共包含 15 个独立服务进程。每个服务负责特定的业务功能，通过 gRPC 进行通信。

---

## 服务列表

### 1. Gateway Service (网关服务)

**进程名：** `gateway`

**连接类型：** 长连接（客户端保持 gRPC Stream）

**状态特征：** 有状态服务（维护客户端连接状态）

**扩展方式：** 直接扩展（客户端按负载均衡连接到不同实例）

**职责：**
- 客户端请求的统一入口
- gRPC 请求路由和转发
- 负载均衡
- 限流和熔断
- 协议转换

**技术特点：**
- 客户端保持长连接
- 支持多实例部署
- 作为客户端和后端服务的中间层
- 连接断开后重连可能到不同实例

---

### 2. Auth Service (认证服务)

**进程名：** `auth`

**连接类型：** 短连接（请求-响应模式）

**状态特征：** 无状态服务

**扩展方式：** 直接扩展

**职责：**
- 对接公司账号平台
- 对接第三方账号平台（微信、QQ、Apple ID 等）
- 验证账号平台的 Account Token
- 签发游戏侧的 Game Token
- 管理账号 ID 到角色 ID 的映射关系

**技术特点：**
- 客户端登录认证后即断开
- JWT Token 签发和验证
- 支持多种第三方登录方式

---

### 3. Game Service (游戏服务)

**进程名：** `game`

**连接类型：** 内部服务（客户端通过 Gateway 调用）

**状态特征：** 有状态服务（在内存中维护玩家数据）

**扩展方式：** 一致性哈希 + Redis 共享状态

**职责：**
游戏核心玩法服务，包含以下功能模块：
- **关卡系统 (Level)**：同屏对抗、派对闯关、关卡配置管理
- **角色服务 (Role)**：角色创建、查询、选择
- **玩家属性 (Player)**：玩家信息、通关记录、战斗力等级
- **背包系统 (Inventory)**：道具管理、背包查询
- **商店系统 (Shop)**：充值钻石、购买礼包和道具
- **任务系统 (Task)**：每日任务、新手任务、任务进度跟踪

**技术特点：**
- 核心游戏逻辑集中处理
- 在内存中缓存玩家数据，提升性能
- 使用 Redis 共享玩家状态，支持跨实例访问
- 按玩家 ID 一致性哈希分配到不同实例

---

### 4. Hall Service (大厅服务)

**进程名：** `hall`

**连接类型：** 内部服务（客户端通过 Gateway 调用）

**状态特征：** 有状态服务（维护大厅实时状态）

**扩展方式：** 一致性哈希 + Redis 共享状态

**职责：**
- 多人在线大厅场景管理
- 大厅内玩家交互
- 大厅玩家列表维护
- 场景元素类似多梦之星主岛

**技术特点：**
- 在内存中维护大厅实时状态
- 使用 Redis 共享大厅状态，支持跨实例访问
- 支持 20-30 人同时在线交互
- 按大厅 ID 一致性哈希分配到不同实例

---

### 5. Match Service (匹配服务)

**进程名：** `match`

**连接类型：** 内部服务（客户端通过 Gateway 调用）

**状态特征：** 无状态服务

**扩展方式：** 直接扩展

**职责：**
- 组队匹配
- 对战匹配
- 匹配算法实现（ELO/MMR）
- 匹配队列管理

**技术特点：**
- 匹配队列存储在 Redis
- 匹配逻辑无状态，任意实例可处理
- 支持多种匹配模式
- 可根据负载动态扩展

---

### 6. Room Service (房间服务)

**进程名：** `room`

**连接类型：** 内部服务（客户端通过 Gateway 调用）

**状态特征：** 有状态服务（维护房间实时状态）

**扩展方式：** 一致性哈希 + Redis 共享状态

**职责：**
- 管理游戏房间实例
- 房间内玩家状态同步
- 实时战斗逻辑
- 支持 20-30 人同屏交互

**技术特点：**
- 在内存中维护房间实时状态
- 按房间 ID 一致性哈希分配到不同实例
- 使用 Redis 共享房间状态，支持跨实例访问
- 支持帧同步或状态同步

---

### 7. Team Service (组队服务)

**进程名：** `team`

**连接类型：** 内部服务（客户端通过 Gateway 调用）

**状态特征：** 无状态服务

**扩展方式：** 直接扩展

**职责：**
- 组队管理
- 队伍创建、解散
- 队伍成员管理
- 队伍状态维护

**技术特点：**
- 队伍信息存储在 Redis
- 服务无状态，任意实例可处理请求
- 支持多人组队
- 与 Match Service 配合进行组队匹配

---

### 8. Rank Service (排行榜服务)

**进程名：** `rank`

**连接类型：** 内部服务（客户端通过 Gateway 调用）

**状态特征：** 无状态服务

**扩展方式：** 直接扩展

**职责：**
- 各类排行榜计算
- 排行榜查询
- 支持多种排行维度（战斗力、通关次数等）

**技术特点：**
- 排行榜数据存储在 Redis Sorted Set
- 服务无状态，任意实例可处理请求
- 支持实时更新和查询
- 可定期持久化到数据库

---

### 9. Mail Service (邮件服务)

**进程名：** `mail`

**连接类型：** 内部服务（客户端通过 Gateway 调用）

**状态特征：** 无状态服务

**扩展方式：** 直接扩展

**职责：**
- 系统邮件发送
- 玩家邮件（P2P）
- 邮件附件管理
- 邮件读取状态跟踪

**技术特点：**
- 邮件数据存储在数据库
- 服务无状态，任意实例可处理请求
- 异步邮件发送
- 支持批量邮件
- 邮件模板管理

---

### 10. Trading Service (交易行服务)

**进程名：** `trading`

**连接类型：** 内部服务（客户端通过 Gateway 调用）

**状态特征：** 无状态服务

**扩展方式：** 直接扩展

**职责：**
- 玩家上架道具
- 其他玩家使用钻石或货币购买
- 官方收取交易税
- 交易记录管理

**技术特点：**
- 交易数据存储在数据库
- 服务无状态，任意实例可处理请求
- 分布式事务处理
- 防止刷单和作弊
- 交易流水持久化

---

### 11. Guild Service (公会服务)

**进程名：** `guild`

**连接类型：** 内部服务（客户端通过 Gateway 调用）

**状态特征：** 无状态服务

**扩展方式：** 直接扩展

**职责：**
- 公会创建、解散
- 公会成员管理
- 公会等级和升级
- 公会活动管理

**技术特点：**
- 公会数据存储在数据库和 Redis
- 服务无状态，任意实例可处理请求
- 使用 Redis 缓存公会信息
- 支持公会聊天（配合 Chat Service）

---

### 12. Doll Service (玩偶服务)

**进程名：** `doll`

**连接类型：** 内部服务（客户端通过 Gateway 调用）

**状态特征：** 无状态服务

**扩展方式：** 直接扩展

**职责：**
包含三个子功能模块：
- **盲盒系统 (Blindbox)**：多个盲盒池子、按权重分配稀有度
- **玩偶融合 (DollMerge)**：N 个玩偶融合成一个新玩偶
- **玩偶兑换 (DollExchange)**：玩偶账号绑定、通过页面填写收货信息、对接物流

**技术特点：**
- 玩偶数据存储在数据库
- 服务无状态，任意实例可处理请求
- 随机算法（权重分配）
- 与第三方物流 API 对接
- 实体商品发货管理

---

### 13. Home Service (家园服务)

**进程名：** `home`

**连接类型：** 内部服务（客户端通过 Gateway 调用）

**状态特征：** 无状态服务

**扩展方式：** 直接扩展

**职责：**
- 家园系统（开垦、种植、收获）
- 建造房子
- 道具出售
- 家园编辑和摆放
- 家园访问（访问其他玩家家园）

**技术特点：**
- 家园数据存储在数据库和 Redis
- 服务无状态，任意实例可处理请求
- 使用 Redis 缓存家园状态
- 定期持久化到数据库
- 支持实时编辑

---

### 14. Chat Service (聊天服务)

**进程名：** `chat`

**连接类型：** 内部服务（客户端通过 Gateway 调用）

**状态特征：** 有状态服务（维护聊天连接状态）

**扩展方式：** 消息队列广播

**职责：**
- 世界频道
- 私聊
- 附近聊天
- 公会聊天

**技术特点：**
- 维护客户端聊天连接状态
- 使用消息队列（Kafka）广播聊天消息
- 所有实例订阅 Kafka Topic，消息可到达任意连接的客户端
- 支持聊天记录持久化
- 敏感词过滤

---

### 15. Friend Service (好友服务)

**进程名：** `friend`

**连接类型：** 内部服务（客户端通过 Gateway 调用）

**状态特征：** 无状态服务

**扩展方式：** 直接扩展

**职责：**
- 好友添加、删除
- 好友拉黑
- 好友列表查询
- 好友在线状态

**技术特点：**
- 好友数据存储在数据库和 Redis
- 服务无状态，任意实例可处理请求
- 使用 Redis 缓存好友关系和在线状态
- 支持好友推荐
- 双向好友关系管理

---

## 服务总结

### 按连接类型分类

#### 客户端直连服务（2个）
- **Gateway**：长连接（客户端保持 gRPC Stream）
- **Auth**：短连接（请求-响应模式）

#### 内部服务（13个）
客户端通过 Gateway 调用，不直接连接：
- Game、Hall、Room、Match、Team、Chat、Friend、Guild、Mail、Trading、Home、Doll、Rank

---

### 按状态特征分类

#### 有状态服务（5个）
服务在内存中维护状态，需要特殊的扩展策略：

| 服务 | 维护的状态 | 扩展方式 |
|------|-----------|---------|
| **Gateway** | 客户端连接状态 | 直接扩展（客户端按负载均衡连接） |
| **Game** | 玩家数据 | 一致性哈希 + Redis 共享状态 |
| **Hall** | 大厅实时状态 | 一致性哈希 + Redis 共享状态 |
| **Room** | 房间实时状态 | 一致性哈希 + Redis 共享状态 |
| **Chat** | 聊天连接状态 | 消息队列广播（Kafka） |

#### 无状态服务（10个）
服务不在内存维护状态，数据存储在数据库或 Redis，可以直接水平扩展：
- Auth、Match、Team、Rank、Mail、Trading、Guild、Doll、Home、Friend

---

### 按扩展方式分类

#### 直接扩展（11个）
无状态服务，增加实例即可：
- Gateway、Auth、Match、Team、Rank、Mail、Trading、Guild、Doll、Home、Friend

#### 一致性哈希 + Redis（3个）
有状态服务，按业务 ID 哈希分配：
- **Game**：按玩家 ID 哈希
- **Hall**：按大厅 ID 哈希
- **Room**：按房间 ID 哈希

#### 消息队列广播（1个）
通过消息队列同步状态：
- **Chat**：所有实例订阅 Kafka Topic，消息广播到所有客户端

---

## 服务依赖关系

```
客户端
  ↓
Gateway (网关)
  ↓
Auth (认证) → 账号平台
  ↓
各业务服务 (Game/Hall/Room/Match/Team/Chat/Friend/Guild/Mail/Trading/Home/Doll/Rank)
  ↓
基础设施 (PostgreSQL/Redis/Kafka/etcd)
```
