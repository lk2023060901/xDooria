#---------------------------------------------------------------------
# xDooria HAProxy 配置 - 开发环境
# 架构：HAProxy -> Nginx -> Login 服务
#---------------------------------------------------------------------

#---------------------------------------------------------------------
# 全局配置
#---------------------------------------------------------------------
global
    # 日志输出到标准输出
    log stdout format raw local0 debug
    # 最大并发连接数
    maxconn 1000
    # 以守护进程方式运行
    daemon

#---------------------------------------------------------------------
# 默认配置
#---------------------------------------------------------------------
defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  forwardfor
    timeout connect 5s
    timeout client  30s
    timeout server  30s
    timeout http-request 10s

#---------------------------------------------------------------------
# 统计监控页面
# 访问地址：http://localhost:8404/stats
#---------------------------------------------------------------------
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE

#---------------------------------------------------------------------
# 前端：HTTP 入口
# 接收所有客户端请求，转发到 Nginx 集群
#---------------------------------------------------------------------
frontend http_front
    bind *:8000
    mode http

    # 健康检查直接返回（不转发）
    acl is_health path /health
    use_backend health_check if is_health

    # Login 服务地址端点
    acl is_login path /api/login
    use_backend login_server_info if is_login

    # 所有其他请求转发到 Nginx 集群
    default_backend nginx_cluster

#---------------------------------------------------------------------
# 前端：gRPC 入口
#---------------------------------------------------------------------
frontend grpc_front
    bind *:9000 proto h2
    mode http

    default_backend nginx_grpc_cluster

#---------------------------------------------------------------------
# 前端：WebSocket/TCP 游戏长连接
#---------------------------------------------------------------------
frontend tcp_front
    bind *:7070
    mode tcp
    option tcplog

    default_backend nginx_tcp_cluster

#---------------------------------------------------------------------
# 后端：健康检查
#---------------------------------------------------------------------
backend health_check
    mode http
    http-request return status 200 content-type text/plain string "OK"

#---------------------------------------------------------------------
# 后端：Login 服务器地址
# 返回 Login 服务的连接地址
#---------------------------------------------------------------------
backend login_server_info
    mode http
    http-request return status 200 content-type "application/json; charset=utf-8" string "{\"host\":\"127.0.0.1\",\"port\":18080}"

#---------------------------------------------------------------------
# 后端：Nginx HTTP 集群
# HAProxy 为 Nginx 提供多活负载均衡
#---------------------------------------------------------------------
backend nginx_cluster
    mode http
    # 轮询负载均衡
    balance roundrobin
    # HTTP 健康检查
    option httpchk GET /health
    http-check expect status 200

    # Nginx 节点（开发环境单节点）
    # check: 启用健康检查
    # inter: 检查间隔
    # fall: 失败次数阈值
    # rise: 恢复次数阈值
    server nginx1 nginx:8080 check inter 5s fall 3 rise 2

#---------------------------------------------------------------------
# 后端：Nginx gRPC 集群
#---------------------------------------------------------------------
backend nginx_grpc_cluster
    mode http
    balance roundrobin
    option httpchk GET /health

    server nginx1 nginx:8090 check inter 5s fall 3 rise 2 proto h2

#---------------------------------------------------------------------
# 后端：Nginx TCP 集群
#---------------------------------------------------------------------
backend nginx_tcp_cluster
    mode tcp
    balance source
    option tcp-check

    server nginx1 nginx:8070 check inter 5s fall 3 rise 2
